
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Implementation &#8212; AIS Connector Library 1.0.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tracking Function" href="tracking function.html" />
    <link rel="prev" title="Getting Started" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="implementation">
<h1>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h1>
<p>Follow these steps to implement AIS Connector Library in your android app project.</p>
<p><strong>Add module to android project</strong></p>
<ol class="arabic simple">
<li>Open your project in Android Studio. Right click on your project and choose <strong>Open Module Setting</strong></li>
</ol>
<a class="reference internal image-reference" href="_images/open-module.png"><img alt="Alternative text" src="_images/open-module.png" style="width: 600px;" /></a>
<ol class="arabic simple" start="2">
<li>Inside project Structure panel, choose <strong>Depedencies</strong> . Inside Declare Depedencies section, click icon <strong>plus (+)</strong> and chosee <strong>JAR Depedency</strong>.</li>
</ol>
<a class="reference internal image-reference" href="_images/project-structure.png"><img alt="Alternative text" src="_images/project-structure.png" style="width: 600px;" /></a>
<ol class="arabic simple" start="3">
<li>Inside Add Jar/Aar Depedency panel, enter path of AIS Connector Libraray, for example /Users/labs247/Desktop/libAis.</li>
</ol>
<a class="reference internal image-reference" href="_images/add-jar.png"><img alt="Alternative text" src="_images/add-jar.png" style="width: 600px;" /></a>
<p><strong>BLE Configuration</strong></p>
<ol class="arabic simple">
<li>BLE Permission</li>
</ol>
<dl class="docutils">
<dt>AIS Connector Library use Bluetooth Low Energy (BLE) to communicate with AIS Device. In order to use Bluetooth features in your application, you must declare the Bluetooth permission <code class="code docutils literal notranslate"><span class="pre">BLUETOOTH</span></code>. You need this permission to perform any Bluetooth communication, such as requesting a connection, accepting a connection, and transferring data.</dt>
<dd><div class="first last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;android.permission.BLUETOOTH&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">uses</span><span class="o">-</span><span class="n">permission</span> <span class="n">android</span><span class="p">:</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span><span class="o">/&gt;</span>
</pre></div>
</div>
</dd>
</dl>
<p>Then at run-time you can determine BLE availability by using <code class="code docutils literal notranslate"><span class="pre">PackageManager.hasSystemFeature():</span></code></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// Use this check to determine whether BLE is supported on the device. Then
// you can selectively disable BLE-related features.
if (!getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) {
Toast.makeText(this, R.string.ble_not_supported, Toast.LENGTH_SHORT).show();
finish();
}
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Get the <code class="code docutils literal notranslate"><span class="pre">BluetoothAdapter</span></code></li>
</ol>
<p>The <code class="code docutils literal notranslate"><span class="pre">BluetoothAdapter</span></code> is required for any and all Bluetooth activity. The <code class="code docutils literal notranslate"><span class="pre">BluetoothAdapter</span></code> represents the device’s own Bluetooth adapter (the Bluetooth radio). There’s one Bluetooth adapter for the entire system, and your application can interact with it using this object. The snippet below shows how to get the adapter. Note that this approach uses <code class="code docutils literal notranslate"><span class="pre">getSystemService()</span></code> to return an instance of <code class="code docutils literal notranslate"><span class="pre">BluetoothManager</span></code>, which is then used to get the adapter. Android 4.3 (API Level 18) introduces <code class="code docutils literal notranslate"><span class="pre">BluetoothManager:</span></code></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="n">BluetoothAdapter</span> <span class="n">bluetoothAdapter</span><span class="p">;</span>
<span class="o">...</span>
<span class="o">//</span> <span class="n">Initializes</span> <span class="n">Bluetooth</span> <span class="n">adapter</span><span class="o">.</span>
<span class="n">final</span> <span class="n">BluetoothManager</span> <span class="n">bluetoothManager</span> <span class="o">=</span>
<span class="p">(</span><span class="n">BluetoothManager</span><span class="p">)</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="o">.</span><span class="n">BLUETOOTH_SERVICE</span><span class="p">);</span>
<span class="n">bluetoothAdapter</span> <span class="o">=</span> <span class="n">bluetoothManager</span><span class="o">.</span><span class="n">getAdapter</span><span class="p">();</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Enable Bluetooth</li>
</ol>
<p>Next, you need to ensure that Bluetooth is enabled. Call <code class="code docutils literal notranslate"><span class="pre">isEnabled()</span></code> to check whether Bluetooth is currently enabled. If this method returns false, then Bluetooth is disabled. The following snippet checks whether Bluetooth is enabled. If it isn’t, the snippet displays an error prompting the user to go to Settings to enable Bluetooth:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>// Ensures Bluetooth is available on the device and it is enabled. If not,
// displays a dialog requesting user permission to enable Bluetooth.
if (bluetoothAdapter == null || !bluetoothAdapter.isEnabled()) {
Intent enableBtIntent = new Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);
startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);
}
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li>Find BLE Devices</li>
</ol>
<p>To find BLE devices, you use the <code class="code docutils literal notranslate"><span class="pre">startLeScan()</span></code> method. This method takes a <code class="code docutils literal notranslate"><span class="pre">BluetoothAdapter.LeScanCallback</span></code> as a parameter. You must implement this callback, because that is how scan results are returned. Because scanning is battery-intensive, you should observe the following guidelines:</p>
<ul class="simple">
<li>As soon as you find the desired device, stop scanning.</li>
<li>Never scan on a loop, and set a time limit on your scan. A device that was previously available may have moved out of range, and continuing to scan drains the battery.</li>
</ul>
<p>The following snippet shows how to start a scan:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>private void startScan() {
        if (!((MainActivity) getActivity()).hasPermissions()|| mScanning) {
            return;
        }
        ...
        mScanResults = new HashMap&lt;&gt;();
        mScanCallback = new BtleScanCallback(mScanResults);

        mBluetoothLeScanner = mBluetoothAdapter.getBluetoothLeScanner();

        // Note: Filtering does not work the same (or at all) on most devices. It also is unable to
        // search for a mask or anything less than a full UUID.
        // Unless the full UUID of the server is known, manual filtering may be necessary.
        // For example, when looking for a brand of device that contains a char sequence in the UUID
        ScanFilter scanFilter = new ScanFilter.Builder()
                .setServiceUuid(new ParcelUuid(SERVICE_UUID))
                .build();
        List&lt;ScanFilter&gt; filters = new ArrayList&lt;&gt;();
        filters.add(scanFilter);

        ScanSettings settings = new ScanSettings.Builder()
                .setScanMode(ScanSettings.SCAN_MODE_LOW_POWER)
                .build();

        mBluetoothLeScanner.startScan(filters, settings, mScanCallback);

        mHandler = new Handler();
        mHandler.postDelayed(this::stopScan, SCAN_PERIOD);

        mScanning = true;
        log(&quot;Started scanning.&quot;);
    }
</pre></div>
</div>
</div></blockquote>
<p>The following snippet shows how to start a scan:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="n">void</span> <span class="n">stopScan</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mScanning</span> <span class="o">&amp;&amp;</span> <span class="n">mBluetoothAdapter</span> <span class="o">!=</span> <span class="n">null</span> <span class="o">&amp;&amp;</span> <span class="n">mBluetoothAdapter</span><span class="o">.</span><span class="n">isEnabled</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">mBluetoothLeScanner</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mBluetoothLeScanner</span><span class="o">.</span><span class="n">stopScan</span><span class="p">(</span><span class="n">mScanCallback</span><span class="p">);</span>
            <span class="n">scanComplete</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="n">mScanCallback</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="n">mScanning</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
        <span class="n">mHandler</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Stopped scanning.&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>You can see the result status using <code class="code docutils literal notranslate"><span class="pre">scanComplete()</span></code></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="n">void</span> <span class="n">scanComplete</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mScanResults</span><span class="o">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">deviceAddress</span> <span class="p">:</span> <span class="n">mScanResults</span><span class="o">.</span><span class="n">keySet</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">BluetoothDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">mScanResults</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">deviceAddress</span><span class="p">);</span>
            <span class="n">GattServerViewModel</span> <span class="n">viewModel</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GattServerViewModel</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

            <span class="n">ViewGattServerBinding</span> <span class="n">binding</span> <span class="o">=</span> <span class="n">DataBindingUtil</span><span class="o">.</span><span class="n">inflate</span><span class="p">(</span><span class="n">LayoutInflater</span><span class="o">.</span><span class="n">from</span><span class="p">(</span><span class="n">getContext</span><span class="p">()),</span>
                    <span class="n">R</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">view_gatt_server</span><span class="p">,</span>
                    <span class="n">mBinding</span><span class="o">.</span><span class="n">serverListContainer</span><span class="p">,</span>
                    <span class="n">true</span><span class="p">);</span>

            <span class="n">binding</span><span class="o">.</span><span class="n">setViewModel</span><span class="p">(</span><span class="n">viewModel</span><span class="p">);</span>
            <span class="n">binding</span><span class="o">.</span><span class="n">connectGattServerButton</span><span class="o">.</span><span class="n">setOnClickListener</span><span class="p">(</span><span class="n">v</span> <span class="o">-&gt;</span> <span class="n">connectDevice</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>If you want to scan for only specific types of peripherals, you can instead call startLeScan(UUID[], BluetoothAdapter.LeScanCallback), providing an array of UUID objects that specify the GATT services your app supports.</p>
<p>Here is an implementation of the BluetoothAdapter.LeScanCallback, which is the interface used to deliver BLE scan results:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="k">class</span> <span class="nc">BtleScanCallback</span> <span class="n">extends</span> <span class="n">ScanCallback</span> <span class="p">{</span>

        <span class="n">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">BluetoothDevice</span><span class="o">&gt;</span> <span class="n">mScanResults</span><span class="p">;</span>

        <span class="n">BtleScanCallback</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">BluetoothDevice</span><span class="o">&gt;</span> <span class="n">scanResults</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">mScanResults</span> <span class="o">=</span> <span class="n">scanResults</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">onScanResult</span><span class="p">(</span><span class="nb">int</span> <span class="n">callbackType</span><span class="p">,</span> <span class="n">ScanResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">addScanResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">onBatchScanResults</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ScanResult</span><span class="o">&gt;</span> <span class="n">results</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">ScanResult</span> <span class="n">result</span> <span class="p">:</span> <span class="n">results</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">addScanResult</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="nd">@Override</span>
        <span class="n">public</span> <span class="n">void</span> <span class="n">onScanFailed</span><span class="p">(</span><span class="nb">int</span> <span class="n">errorCode</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">logError</span><span class="p">(</span><span class="s2">&quot;BLE Scan Failed with code &quot;</span> <span class="o">+</span> <span class="n">errorCode</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">private</span> <span class="n">void</span> <span class="n">addScanResult</span><span class="p">(</span><span class="n">ScanResult</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BluetoothDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">getDevice</span><span class="p">();</span>
            <span class="n">String</span> <span class="n">deviceAddress</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">getAddress</span><span class="p">();</span>
            <span class="n">mScanResults</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">deviceAddress</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="5">
<li>Connect to GATT Server</li>
</ol>
<p>The first step in interacting with a BLE device is connecting to it— more specifically, connecting to the GATT server on the device. To connect to a GATT server on a BLE device, you use the <code class="code docutils literal notranslate"><span class="pre">connectGatt()</span></code> method. This method takes three parameters: a <code class="code docutils literal notranslate"><span class="pre">Context</span></code> object, <code class="code docutils literal notranslate"><span class="pre">autoConnect</span></code> (boolean indicating whether to automatically connect to the BLE device as soon as it becomes available), and a reference to a <code class="code docutils literal notranslate"><span class="pre">BluetoothGattCallback:</span></code></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">private</span> <span class="n">void</span> <span class="n">connectDevice</span><span class="p">(</span><span class="n">BluetoothDevice</span> <span class="n">device</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">GattClientCallback</span> <span class="n">gattClientCallback</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GattClientCallback</span><span class="p">();</span>
       <span class="n">mGatt</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">connectGatt</span><span class="p">(</span><span class="n">getContext</span><span class="p">(),</span> <span class="n">false</span><span class="p">,</span> <span class="n">gattClientCallback</span><span class="p">);</span>
   <span class="p">}</span>
</pre></div>
</div>
</div></blockquote>
<p>This connects to the GATT server hosted by the BLE device, and returns a <code class="code docutils literal notranslate"><span class="pre">BluetoothGatt</span></code> instance, which you can then use to conduct GATT client operations. The caller (the Android app) is the GATT client. The <code class="code docutils literal notranslate"><span class="pre">BluetoothGattCallback</span></code> is used to deliver results to the client, such as connection status, as well as any further GATT client operations.</p>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">AIS Connector Library</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tracking function.html">Tracking Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="tagging function.html">Tagging Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="sos function.html">SOS Function</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Getting Started</a></li>
      <li>Next: <a href="tracking function.html" title="next chapter">Tracking Function</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Solusi247.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/implementation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>